<script>
    // Initialize DB and a Global Design key
    let db = JSON.parse(localStorage.getItem('bs_apps')) || [];
    let globalDesign = localStorage.getItem('bs_global_design') || null; 
    
    let currentPhotos = { f: null, s: null, b: null };
    let currentUserEmail = null;

    function previewFile(type) {
        const file = document.getElementById(type + '_img').files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            currentPhotos[type] = reader.result;
            document.getElementById('box_' + type).classList.add('done');
            document.getElementById('box_' + type).innerText = "FILE LOADED";
        }
        if (file) reader.readAsDataURL(file);
    }

    // UPDATED: Logic for Planned Design Upload with password '1234'
    function adminUploadDesign() {
        const pass = prompt("Enter Admin Password to upload design:");
        if(pass === "1234") { // Required password updated
            document.getElementById('design-upload-input').click();
        } else if (pass !== null) {
            alert("Incorrect password.");
        }
    }

    // UPDATED: Process upload to Global Storage for real-time visibility
    function processDesignUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = e.target.result;
            // Save globally so ANY member who logs in sees it
            localStorage.setItem('bs_global_design', imageData);
            displayDesign(imageData);
            alert("Design updated for all members.");
        };
        reader.readAsDataURL(file);
    }

    // Displays the design (Admin sees '+' if empty, User sees image)
    function displayDesign(imgData) {
        const imgEl = document.getElementById('design-display-img');
        const plusEl = document.getElementById('design-plus-icon');
        
        if (imgData) {
            imgEl.src = imgData;
            imgEl.style.display = 'block';
            plusEl.style.display = 'none';
            // Only admins should click to change, triggered by the same function
            imgEl.onclick = adminUploadDesign;
            imgEl.style.cursor = 'pointer';
        } else {
            imgEl.style.display = 'none';
            plusEl.style.display = 'flex';
        }
    }

    function toggleAdmin() {
        const pass = prompt("Enter Admin Password:");
        if(pass === "1234") { // Updated for consistency
            document.getElementById('admin-panel').style.display = 'block';
            loadApplications();
        }
    }

    function openPortal() { document.getElementById('model-portal').style.display = 'block'; }
    
    function closeAll() { 
        document.querySelectorAll('#admin-panel, #model-portal').forEach(el => el.style.display = 'none');
        document.getElementById('portal-login').style.display = 'block';
        document.getElementById('portal-content').style.display = 'none';
        document.getElementById('portalEmail').value = "";
        currentUserEmail = null;
    }

    document.getElementById('applicationForm').onsubmit = function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "UPLOADING...";
        btn.disabled = true;

        const newApp = {
            id: Date.now(),
            name: document.getElementById('name').value,
            email: document.getElementById('email').value.toLowerCase().trim(),
            approved: false,
            booking: null,
            photos: { ...currentPhotos },
            date: new Date().toLocaleString()
        };

        db.push(newApp);
        localStorage.setItem('bs_apps', JSON.stringify(db));
        btn.innerText = "SUCCESS ✓";
        btn.classList.add('success');
        setTimeout(() => location.reload(), 1500);
    };

    function loadApplications() {
        const list = document.getElementById('applications-list');
        list.innerHTML = db.length ? "" : "<p style='color:#555;'>No applications yet.</p>";
        [...db].reverse().forEach(app => {
            const row = document.createElement('div');
            row.className = 'app-row';
            row.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h3 style="margin:0; color:var(--accent);">${app.name}
                            <span class="status-badge ${app.approved ? 'status-approved' : 'status-pending'}">
                                ${app.approved ? '✓ APPROVED' : 'PENDING'}
                            </span>
                        </h3>
                        <small style="color:#aaa;">${app.email} • Submitted: ${app.date}</small>
                    </div>
                    <div>
                        ${!app.approved ? `<button class="admin-btn btn-approve" onclick="approveApp(${app.id})">Approve</button>` : ''}
                        <button class="admin-btn btn-delete" onclick="deleteApp(${app.id})">Delete</button>
                    </div>
                </div>
                <div class="admin-photo-display" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:15px;">
                    <img src="${app.photos.f || 'https://via.placeholder.com/150'}">
                    <img src="${app.photos.s || 'https://via.placeholder.com/150'}">
                    <img src="${app.photos.b || 'https://via.placeholder.com/150'}">
                </div>
            `;
            list.appendChild(row);
        });
    }

    function approveApp(id) {
        const app = db.find(a => a.id === id);
        if(app && confirm(`Approve ${app.name}?`)) {
            app.approved = true;
            localStorage.setItem('bs_apps', JSON.stringify(db));
            loadApplications();
        }
    }

    function deleteApp(id) {
        if(confirm("Permanently delete this application?")) {
            db = db.filter(app => app.id !== id);
            localStorage.setItem('bs_apps', JSON.stringify(db));
            loadApplications();
        }
    }

    function checkAccess() {
        const emailInput = document.getElementById('portalEmail').value.toLowerCase().trim();
        const user = db.find(app => app.email === emailInput);

        if (!user) { alert("No application found with this email."); return; }
        if (!user.approved) { alert("Application pending approval."); return; }

        currentUserEmail = emailInput;
        document.getElementById('portal-login').style.display = 'none';
        document.getElementById('portal-content').style.display = 'block';
        document.getElementById('welcomeName').innerText = "MUSE: " + user.name;
        
        // Load the global design so all approved models see it
        const currentGlobalDesign = localStorage.getItem('bs_global_design');
        displayDesign(currentGlobalDesign); 

        if (user.booking) {
            showConfirmed(user.booking);
        } else {
            document.getElementById('booking-section').style.display = 'block';
            document.getElementById('booking-confirmed').style.display = 'none';
        }
    }

    function confirmBooking() {
        const bookingData = {
            day: document.getElementById('selectedDate').value,
            time: document.getElementById('selectedTime').value
        };
        const user = db.find(app => app.email === currentUserEmail);
        if (user) {
            user.booking = bookingData;
            localStorage.setItem('bs_apps', JSON.stringify(db));
            showConfirmed(bookingData);
        }
    }

    function showConfirmed(booking) {
        document.getElementById('booking-section').style.display = 'none';
        document.getElementById('booking-confirmed').style.display = 'block';
        document.getElementById('displayBooking').innerText = `${booking.day} at ${booking.time}`;
    }
</script>
